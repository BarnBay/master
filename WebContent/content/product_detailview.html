<script type="text/javascript">
	var checkFormular = true;
	var GoogleMapsAddress = [];
	var GoogleMapsTitle = [];
	
	var ProductDetailJSONObject;
	var ProductDetailName;
	var ProductPrice;
	var ProductDetailDescription;
	var ProductFarmerDescription;
	
	if($.cookie("Farmer.ProductID") && $.cookie("Farmer.FarmerID")) {
		
		$.ajax({
			url: "/barnbay_ui/GetCheapestProduct?id=" + $.cookie("Farmer.ProductID")
		}).done(function(data) {
			ProductDetailJSONObject = JSON.parse(data);
			ProductDetailName = ProductDetailJSONObject.name;
			ProductDetailDescription = ProductDetailJSONObject.description
			ProductFarmerDescription = ProductDetailJSONObject.farmerproductdescription;
		});
		
		$.ajax({
			url: "/barnbay_ui/GetProductByCategoryAndFarmer?catid=" + $.cookie("Farmer.ProductID") + "&farmerid=" + $.cookie("Farmer.FarmerID")
		}).done(function(data) {
			ProductDetailJSONObject = JSON.parse(data);
			ProductFarmerDescription = ProductDetailJSONObject[0].description;
			
			productDetailFunction(ProductDetailJSONObject[0]);

			/* Start Google Maps */
			GoogleMapsAddress.push(ProductDetailJSONObject[0].farmeraddress.street + ' ' + ProductDetailJSONObject[0].farmeraddress.number + ', ' + ProductDetailJSONObject[0].farmeraddress.zipcode + ' ' + ProductDetailJSONObject[0].farmeraddress.city);
			GoogleMapsTitle.push(ProductDetailJSONObject[0].farmerfirstname + ' ' + ProductDetailJSONObject[0].farmerlastname);
			
			startMap();
		});
		
		$.removeCookie("Farmer.ProductID");
		$.removeCookie("Farmer.FarmerID");

	} else {
		$.ajax({
			url: "/barnbay_ui/GetCheapestProduct?id=" + $.cookie("Product.ProductListCategoryID")
		}).done(function(data) {
			ProductDetailJSONObject = JSON.parse(data);
			ProductDetailName = ProductDetailJSONObject.name;
			ProductDetailDescription = ProductDetailJSONObject.description
			ProductFarmerDescription = ProductDetailJSONObject.farmerproductdescription;
			
			productDetailFunction(ProductDetailJSONObject);
			
			/* Start Google Maps */
			GoogleMapsAddress.push(ProductDetailJSONObject.farmeraddress.street + ' ' + ProductDetailJSONObject.farmeraddress.number + ', ' + ProductDetailJSONObject.farmeraddress.zipcode + ' ' + ProductDetailJSONObject.farmeraddress.city);
			GoogleMapsTitle.push(ProductDetailJSONObject.farmerfirstname + ' ' + ProductDetailJSONObject.farmerlastname);
			
			startMap();
		});
	}
</script>

<div class="row">
	<div class="col-md-12">
		<div class="alert alert-success alert-block fade in" id="successAlert" style="display: none;">
			<button type="button" class="close" data-dismiss="alert">&times;</button>
			<h4>Success!</h4>
			<p>You successfully add the Product to your shopping-cart</p>
		</div>
	</div>
</div>

<!-- JSON - Create the Product List -->
<div class="row" id="productDetailInformation">
	<script type="text/javascript">							
		function productDetailFunction(productDetailObject) {
			var out = "";
			
			out += '<div class="col-sm-12" style="font-family: \'Roboto Condensed\', sans-serif;">';
			out += '	<div class="col-sm-5">';
			out += '		<img src="./img/products/' + ProductDetailName + '.png" alt="Image" class="img-responsive center-block">';
			out += '	</div>';
			out += '	<div class="col-sm-7 productDetail">';
			out += '		<h2>' + ProductDetailName + '</h2>';
			out += '		<h5>' + ProductDetailDescription + '</h5>';
			out += '		<hr>';
			out += '		<div class="row manufacturer">';
			out += '			<div class="col-sm-2">';
			out += '				<span>Stock:</span>';
			out += '			</div>';
			out += '			<div class="col-sm-10">';
			out += '				' + productDetailObject.stock;
			out += '			</div>';
			out += '			<div class="col-sm-2">';
			out += '				<span>Description:</span>';
			out += '			</div>';
			out += '			<div class="col-sm-10">';
			out += '				' + ProductFarmerDescription;
			out += '			</div>';
			out += '		</div>';
			out += '		<hr>';
			out += '		<form id="addProductToShoppingCart" accept-charset="utf-8" role="form">';
			out += '			<button type="submit" id="addProductToCartButton" class="btn btn-success pull-right">';
			out += '				<span class="glyphicon glyphicon-shopping-cart"></span> Add to Cart';
			out += '			</button>';
			out += '			<div class="price">';
			out += '				<span class="price-head">Price:</span>';
			out += '				<span class="price-new">' + (productDetailObject.price).toFixed(2) + ' &euro;</span> ';
			out += '			</div>';
			out += '			<hr>';
			out += '			<div class="row productFamerLocation">';
			out += '				<div class="col-sm-2">';
			out += '					<span>Farmer:</span>';
			out += '				</div>';
			out += '				<div class="col-sm-10">';
			out += '					<select class="form-control input-md" id="selectproductDetailFarmer" onchange="productFarmerSelect(this)">';
			
			//ProductPrice = productDetailObject.price;
			ProductPrice = (productDetailObject.price).toFixed(2);
			for(i = 0; i < productDetailObject.farmers.length; i++) {
				if((productDetailObject.farmerfirstname == productDetailObject.farmers[i].firstname) && (productDetailObject.farmerlastname == productDetailObject.farmers[i].lastname)) {
					out += '						<option value="' + productDetailObject.farmers[i].idfarmer + '" selected="selected">' + productDetailObject.farmers[i].firstname + ' ' + productDetailObject.farmers[i].lastname + '</option>';
				} else {
					out += '						<option value="' + productDetailObject.farmers[i].idfarmer + '">' + productDetailObject.farmers[i].firstname + ' ' + productDetailObject.farmers[i].lastname + '</option>';	
				}
			}
			
			out += '					</select>';
			out += '				</div>';
			out += '			</div>';
			out += '			<div class="row productFamerLocation">';
			out += '				<div class="col-sm-2">';
			out += '					<span>BarnBay:</span>';
			out += '				</div>';
			out += '				<div class="col-sm-10">';
			out += '					<select class="form-control input-md" id="selectproductDetailLocation">';
			
			for(i = 0; i < productDetailObject.barnbays.length; i++) {
				out += '						<option value="' + productDetailObject.barnbays[i].id + '">' + productDetailObject.barnbays[i].name + '</option>';	
			}
			
			out += '					</select>';
			out += '				</div>';
			out += '			</div>';
			out += '			<div class="row productFamerLocation">';
			out += '				<div class="col-sm-2">';
			out += '					<span>Quantity:</span>';
			out += '				</div>';
			out += '				<div class="col-sm-10">';
			out += '					<input type="number" class="form-control" id="exampleInputQuantity" maxlength="4" min="1" max="' + productDetailObject.stock + '" placeholder="1 kg" required />';
			out += '				</div>';
			out += '			</div>';
			out += '		</form>';
			out += '	</div>';
			out += '	<br/>';
			out += '	<div class="col-sm-12" style="font-size: 16px">';
			out += '	<hr>';
			out += '		<div class="col-sm-4">';
			out += '			<div class="panel panel-success">';
			out += '				<div class="panel-heading">';
			out += '					<span class="glyphicon glyphicon-pushpin" aria-hidden="true"></span> Address';
			out += '				</div>';
			out += '				<div class="panel-body" style="padding-bottom: 0px;">';
			out += '					<address>';
			out += '						<strong>' + productDetailObject.farmerfirstname + ' ' + productDetailObject.farmerlastname + '</strong>';
			out += '						<br/>';
			out += '						' + productDetailObject.farmeraddress.street + ' ' + productDetailObject.farmeraddress.number;
			out += '						<br/>';
			out += '						' + productDetailObject.farmeraddress.zipcode + ' ' + productDetailObject.farmeraddress.city;
			out += '						<br/>';
			out += '						Telefon';
			out += '						<br/>';
			out += '						' + productDetailObject.farmeremail;
			out += '					</address>';
			out += '				</div>';
			out += '			</div>';
			out += '		</div>';
			out += '		<div class="col-sm-8">';
			out += '			<div class="panel panel-success">';
			out += '				<div class="panel-heading">';
			out += '					<span class="glyphicon glyphicon-time" aria-hidden="true"></span> BarnBay pickup Locations';
			out += '				</div>';
			out += '				<div class="panel-body">';
			out += '					<table class="table table-striped">';
			out += '						<tr>';
			out += '							<th>Name</th>';
			out += '							<th>Zip Code</th>';
			out += '							<th>Address</th>';
			out += '							<th>Pick-Up Times</th>';
			out += '						</tr>';
			
			for(i = 0; i < productDetailObject.barnbays.length; i++) {
				out += '						<tr>';
				out += '							<td>' + productDetailObject.barnbays[i].name + '</td>';
				out += '							<td>' + productDetailObject.barnbays[i].address.zipcode + ' ' + productDetailObject.barnbays[i].address.city + '</td>';
				out += '							<td>' + productDetailObject.barnbays[i].address.street + ' ' + productDetailObject.barnbays[i].address.number + '</td>';
				out += '							<td>' + productDetailObject.barnbays[i].opening_hours + '</td>';
				out += '						</tr>';
				
				GoogleMapsAddress.push(productDetailObject.barnbays[i].address.street + ' ' + productDetailObject.barnbays[i].address.number + ', ' + productDetailObject.barnbays[i].address.zipcode + ' ' + productDetailObject.barnbays[i].address.city);
				GoogleMapsTitle.push(productDetailObject.barnbays[i].name);
			}
	
			out += '					</table>';
			out += '				</div>';
			out += '			</div>';
			out += '		</div>';
			out += '		<br/>';
			out += '	</div>';
			out += '	<br/>';
			out += '	<div class="col-sm-12" style="font-size: 16px">';
			out += '		<div class="col-sm-12">';
			out += '			<div class="panel panel-success">';
			out += '				<div class="panel-heading">';
			out += '					<span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span> Farmer and BarnBay-Pickup Locations';
			out += '				</div>';
			out += '				<div class="panel-body">';
			out += '					<div id="map_canvas" style="width: 100%; height: 480px;"></div>';
			out += '				</div>';
			out += '			</div>';
			out += '		</div>';
			out += '	</div>';
			out += '</div>';
			
			document.getElementById("productDetailInformation").innerHTML = out;
		}
	</script>
</div>

<script type="text/javascript">
	function productFarmerSelect(element) {
		$.ajax({
			url: "/barnbay_ui/GetProductByCategoryAndFarmer?catid=" + $.cookie("Product.ProductListCategoryID") + "&farmerid=" + element.value
		}).done(function(data) {
			ProductDetailJSONObject = JSON.parse(data);
			ProductFarmerDescription = ProductDetailJSONObject[0].description;
			
			productDetailFunction(ProductDetailJSONObject[0]);
			
			/* Start Google Maps */
			GoogleMapsAddress.push(ProductDetailJSONObject[0].farmeraddress.street + ' ' + ProductDetailJSONObject[0].farmeraddress.number + ', ' + ProductDetailJSONObject[0].farmeraddress.zipcode + ' ' + ProductDetailJSONObject[0].farmeraddress.city);
			GoogleMapsTitle.push(ProductDetailJSONObject[0].farmerfirstname + ' ' + ProductDetailJSONObject[0].farmerlastname);
			
			startMap();
		});
	}
	
	
	$('#mainContainer').on('submit', '#addProductToShoppingCart', function(event) {
		event.preventDefault();
		
		if($.cookie('User.Session')) {
			if(checkFormular) {
				checkFormular = false;
				
				$('#addProductToCartButton').prop('disabled', true);
				
				var obj = JSON.parse($.cookie('Products.ShoppingCart'));
				
				var productID = $.cookie("Product.ProductListCategoryID");
				var productName = ProductDetailName;
				var productPrice = ProductPrice;
				var productQuantity = $("#exampleInputQuantity").val();
				var farmerID = $("#selectproductDetailFarmer option:selected").val();
				var farmerName = $("#selectproductDetailFarmer option:selected").text();
				var barnbayID = $("#selectproductDetailLocation option:selected").val();
				var barnbayName = $("#selectproductDetailLocation option:selected").text();
								
				obj['shoppingcart'].push({"productID":productID,"productName":productName,"productPrice":productPrice,"productQuantity":productQuantity,"farmerID":farmerID,"farmerName":farmerName,"barnbayID":barnbayID,"barnbayName":barnbayName});			
				$.cookie('Products.ShoppingCart', JSON.stringify(obj));
								
				$('#successAlert').slideDown();
				
				/* Call Mini Shoping Card Method */
				updateMiniShoppingCart();
			}
		} else {
			$('#productAddToCartLogin').modal('show'); 	
		}
	});	
</script>

<!-- Modal Login -->
<div class="modal fade" id="productAddToCartLogin" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
  			<div class="modal-header">
    			<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
    			<h4 class="modal-title" id="myModalLabel">Please Login</h4>
  			</div>
  			<div class="modal-body">
    			If you want to add some Products to you Shopping-Card you must Login
  			</div>
  			<div class="modal-footer">
    			<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
  			</div>
		</div>
	</div>
</div>

<!-- Google Maps Scripte -->
<script type="text/javascript">
	var markerBounds, geocoder, map;
	
	function startMap() {
		
 		var mapOptions = {
     		zoom: 12,
     		disableDefaultUI: true,
     	    mapTypeId: google.maps.MapTypeId.ROADMAP
    	}
 		
 	  	geocoder = new google.maps.Geocoder();
 		markerBounds = new google.maps.LatLngBounds();
 	    map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
 	    
 	   	for (var i = 0; i < GoogleMapsAddress.length; i++) {
 	   		var address = GoogleMapsAddress[i];
 	   		var title = GoogleMapsTitle[i];
 	   		
	 	  	geocoder.geocode({'address': address}, function(results, status) {
		 	  	if(status == google.maps.GeocoderStatus.OK) {
		 	  		map.setCenter(results[0].geometry.location);
		 	  		var marker = new google.maps.Marker({
		 	  			map: map,
		 	  			position: results[0].geometry.location
		 	  		});
		 	  		
		 	  		var infowindow = new google.maps.InfoWindow({
		 	  			content: '<div style="width: 150px;"><h4>' + title + '</h4></div>'
	  	  	  		});
		 	  		
		 	  		google.maps.event.addListener(marker, 'click', function() {
						infowindow.open(map, marker);
					});
		 	  		
		 	  		markerBounds.extend(results[0].geometry.location);
					map.fitBounds(markerBounds);
				} else {
		 	    	alert("Geocode was not successful for the following reason: " + status);
		 	   	}
			});
 	   	}
 	  	
 	  	GoogleMapsAddress = [];
 	  	GoogleMapsTitle = [];
  	}
 </script>